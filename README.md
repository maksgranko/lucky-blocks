# LuckyBlocks — плагин и конфигурация

## Описание

LuckyBlocks — расширяемый плагин для Minecraft, реализующий уникальные лакиблоки с гибкой системой событий, уровней и типов. Все детали управляются YAML-конфигами, что максимально удобно для кастомизации и интеграции на сервер.

---

## Конфиг-файлы

### `luckyblocks.yml`

Основной файл для определения типов лакиблоков, уровней, набора событий и поведения при активации.

**Пример структуры:**
```yaml
types:
  positive:
    item:
      material: SPONGE
      custom-model-data: 1001
    levels:
      1:
        display-name: "&aПоложительный ЛакиБлок &eI уровня"
        events:
          EXPLOSION:
            enabled: false
            weight: 100
            power: 4.0
          DROP_ITEM:
            - enabled: true
              weight: 500
              items:
                - item: GOLDEN_APPLE
                  custom-model-data: 2
                  name: "Золотое яблоко"
                  lore: "Лучший ужин!"
                  amount: 2
          # остальные события (PLACE_BLOCK, PLACE_CHEST ...)
```
**Поля:**
- `types` — ключи (positive, negative и др.) — название типа лакиблока
- `item.material` — отображаемый материал (SPONGE, DIAMOND блок и др.)
- `item.custom-model-data` — для ресурспаков (необязательно)
- `levels` — уровни; для каждого уровня свой display-name и набор events
- `events` — поддерживаемые события (EXPLOSION, DROP_ITEM, PLACE_BLOCK, PLACE_CHEST)
  - `enabled` (bool) — использовать или нет данное событие
  - `weight` (int) — “шанс” выпадения события, влияет на выбор рандомного события
  - параметры события (см. описание каждого события ниже)

---

### `chests.yml`

Таблицы лута для событий типа PLACE_CHEST. Встраивается в конфиг через `item-table` (см. examples).

**Пример:**
```yaml
positive:
  main_loot:
    slots: 27
    loot:
      - items:
          - item: DIAMOND
            amount: 5
            name: "§bАлмаз"
        weight: 50
negative:
  bad_loot:
    slots: 27
    loot:
      - items:
          - item: DIRT
            amount: 5
            name: "&8Плохая грязь"
        weight: 10
```
**Поля:**
- `[type]` — positive/negative и т.д., должны совпадать с luckyblocks.yml
- `[item-table]` — название таблицы (main_loot, bad_loot и др.)
- `slots` — размер генерируемого сундука
- `loot` — список вариантов "набора лута" (у каждого weight и список items)

---

## Атрибуты предметов (items)

В любом месте, где фигурирует объект `items`, поддерживаются:
- `item`: (название предмета, материал Minecraft)
- `amount`: количество
- `name`: название (можно с цветами — &a, §b)
- `lore`: описание (одной строкой или через | многострочно)
- `custom-model-data`: id для ресурспака
- `attributes`: список атрибутов (урон, здоровье и др.), например:
```yaml
attributes:
  - attribute: GENERIC_ATTACK_DAMAGE
    amount: 4
    operation: ADD_NUMBER
```

---

## Флаг отладки (`plugin.getDebug()`)

Статический флаг `plugin.getDebug()` контролирует вывод подробной отладочной информации в консоль сервера.

-   `false` (по умолчанию): Отладочная информация не выводится.
-   `true`: В консоль сервера выводятся подробные логи о процессе генерации сундуков, диагностике событий, дампах лута и действиях с лакиблоками.

Этот флаг полезен для разработчиков и администраторов серверов при отладке конфигурации или поиске проблем.

В новой версии может быть изменён во время игры через /luckyblock debug on/off
---

## Загрузка и перезагрузка конфигов

Плагин автоматически выгружает дефолтные luckyblocks.yml и chests.yml при первом запуске.
Для применения новых настроек используйте команду перезагрузки (если реализовано).

---

## Пример быстрого старта

1. Скопируйте исходные luckyblocks.yml и chests.yml в папку data вашего сервера.
2. Можно свободно добавлять свои типы, уровни, кастомные события, не меняя структуру ядра.
3. Для включения отладки выставьте `plugin.getDebug() = true` (например, через консоль/IDE).

---

## Команды плагина

Плагин предоставляет следующие команды для взаимодействия:

- `/luckyblock` или `/lb`: Основная команда плагина.
  - `/luckyblock give <игрок> <тип> [уровень] [количество]`: Выдает указанному игроку лакиблок определенного типа и уровня. Если уровень не указан, используется случайный доступный уровень для данного типа.
  - `/luckyblock reload`: Перезагружает конфигурационные файлы `luckyblocks.yml` и `chests.yml`. Требует прав администратора.

---

## Принцип работы

При разрушении лакиблока плагин выполняет следующие шаги:

1.  Проверяет, является ли разрушенный блок лакиблоком, зарегистрированным в конфигурации.
2.  Определяет тип и уровень лакиблока.
3.  Используя веса событий, указанные в `luckyblocks.yml` для данного типа и уровня, случайным образом выбирает одно событие для выполнения.
4.  Выполняет логику выбранного события, используя соответствующие параметры из конфига.

---

## Структура кода

Основные компоненты плагина:

-   `LuckyBlockPlugin`: Главный класс плагина, отвечает за инициализацию, регистрацию событий и команд, а также управление конфигурацией.
-   `ConfigManager`: Управляет загрузкой и доступом к данным из `luckyblocks.yml` и `chests.yml`.
-   `ICustomEvent` и классы в пакете `events`: Интерфейс для определения пользовательских событий и их реализации. Каждый класс события содержит логику его выполнения.
-   `BlockBreakListener`, `BlockPlaceListener`, `BlockProtectionListener`, `ExplosionListener`: Слушатели событий Bukkit, обрабатывающие взаимодействие с блоками и взрывы.
-   `LuckyBlockCommand`, `LuckyBlockTabCompleter`: Обрабатывают команды плагина и предоставляют автодополнение.
-   `ProbabilityCalculator`: Отвечает за выбор случайного события на основе весов.
-   `Replacer`: Утилита для замены плейсхолдеров в строках (например, в командах).
-   `LuckyBlockReplaceManager`: Управляет списком локаций блоков, которые могут быть заменены (используется для предотвращения двойного срабатывания при разрушении).

---

## Расширение плагина: Создание собственных событий

Вы можете создавать собственные события, реализовав интерфейс `ICustomEvent`. Этот интерфейс имеет один метод `execute`, который содержит логику вашего события.

```java
public interface ICustomEvent {
    void execute(Player player, Location location, ConfigurationSection eventConfig, LuckyBlockPlugin plugin);
}
```

-   `player`: Игрок, который активировал лакиблок.
-   `location`: Местоположение лакиблока.
-   `eventConfig`: Секция конфигурации из `luckyblocks.yml` для данного события, содержащая его параметры.
-   `plugin`: Экземпляр главного класса плагина.

После создания класса события, вам необходимо зарегистрировать его в `EventRegistry` плагина. Обычно это делается в методе `onEnable` главного класса плагина.

---

## Все события и параметры (`events`)

В конфиге для каждого уровня лакиблока указываются поддерживаемые события (events) и их параметры. Вот полный список:

### EXPLOSION
**Описание:** Вызывает взрыв в точке лакиблока (аналог TNT, но с контролем параметров).
**Пример:**
```yaml
EXPLOSION:
  enabled: true
  weight: 100
  power: 4.0
```
**Параметры:**
- `enabled` (bool) — использовать или нет данное событие
- `weight` (int) — “шанс” выпадения события
- `power` (float) — сила взрыва (по аналогии с TNT = 4.0)
- `set-fire` (bool, опционально) - поджигать ли блоки
- `break-blocks` (bool, опционально) - разрушать ли блоки
- `execute` (секция, опционально) - секция для цепочки команд/событий (см. раздел "Цепочка событий")

---

### DROP_ITEM
**Описание:** Выдаёт игроку один или несколько предметов.
**Пример:**
```yaml
DROP_ITEM:
  enabled: true
  weight: 200
  item: DIAMOND
  amount: 3
```
или, если много вариантов:
```yaml
DROP_ITEM:
  - enabled: true
    weight: 400
    items:
      - item: DIAMOND
        amount: 2
      - item: GOLDEN_APPLE
        amount: 1
```
**Параметры:**
- `enabled` (bool)
- `weight` (int)
- `item` (или `items`) — название предмета или список предметов (см. раздел “Атрибуты предметов”)
- `amount` (int) — количество (используется с `item`)
- Поддерживает все параметры из “атрибутов предметов” (custom-model-data, name, lore, attributes и др.) для каждого предмета в списке `items`.
- `execute` (секция, опционально) - секция для цепочки команд/событий (см. раздел "Цепочка событий")

---

### PLACE_BLOCK
**Описание:** Устанавливает блоки (или несколько блоков) возле лакиблока (например, бриллиантовый блок сверху).
**Пример:**
```yaml
PLACE_BLOCK:
  enabled: true
  weight: 50
  blocks:
    - material: DIAMOND_BLOCK
      relative-coords: { x: 0, y: 1, z: 0 }
    - material: EMERALD_BLOCK
      relative-coords: { x: 2, y: 0, z: 0 }
```
**Параметры:**
- `enabled` (bool)
- `weight` (int)
- `material` (строка) - материал блока (используется с одиночным блоком)
- `blocks` (список) - список блоков для установки. Каждый элемент списка имеет:
    - `material` (строка) - материал блока
    - `relative-coords` (объект) — смещение относительно лакиблока (`x`, `y`, `z`)
    - `custom-model-data` (int, опционально) — для ресурспака
- `relative-coords` (объект) — смещение относительно лакиблока (`x`, `y`, `z`) (используется с одиночным блоком)
- `custom-model-data` (int, опционально) — для ресурспака (используется с одиночным блоком)
- `execute` (секция, опционально) - секция для цепочки команд/событий (см. раздел "Цепочка событий")

---

### PLACE_CHEST
**Описание:** Создаёт сундук с лутом по указанной таблице из `chests.yml`.
**Пример:**
```yaml
PLACE_CHEST:
  enabled: true
  weight: 40
  item-table: main_loot
  relative-coords: { x: 1, y: 0, z: 0 }
```
**Параметры:**
- `enabled` (bool)
- `weight` (int)
- `item-table` (строка) — название таблицы из chests.yml
- `relative-coords` (объект) — смещение
- `replace-existing` (bool, опционально) - заменять ли существующий блок сундуком
- `execute` (секция, опционально) - секция для цепочки команд/событий (см. раздел "Цепочка событий")

---

### COMMAND_EXEC
**Описание:** Выполняет указанные команды от имени сервера.
**Пример:**
```yaml
COMMAND_EXEC:
  enabled: true
  weight: 30
  command: "give %player% minecraft:diamond 3"
```
или, если много команд:
```yaml
COMMAND_EXEC:
  enabled: true
  weight: 30
  commands:
    - "give %player% minecraft:diamond 3"
    - "effect give %player% speed 10 2"
```
**Параметры:**
- `enabled` (bool)
- `weight` (int)
- `command` (строка) — одиночная команда
- `commands` (список строк) — список команд
- Допускаются плейсхолдеры (см. раздел "Поддерживаемые плейсхолдеры").
- `execute` (секция, опционально) - секция для цепочки команд/событий (см. раздел "Цепочка событий")

---

### PLAYER_COMMAND
**Описание:** Выполняет команду от имени игрока.
**Пример:**
```yaml
PLAYER_COMMAND:
  enabled: true
  weight: 25
  command: "say Я поймал лакиблок!"
```
или, если много команд:
```yaml
PLAYER_COMMAND:
  enabled: true
  weight: 25
  commands:
    - "say Я поймал лакиблок!"
    - "me радуется"
```
**Параметры:**
- `enabled` (bool)
- `weight` (int)
- `command` (строка) — одиночная команда
- `commands` (список строк) — список команд
- Допускаются плейсхолдеры (см. раздел "Поддерживаемые плейсхолдеры").
- `execute` (секция, опционально) - секция для цепочки команд/событий (см. раздел "Цепочка событий")

---

### HEAL
**Описание:** Лечит игрока и/или даёт доп. эффекты.
**Пример:**
```yaml
HEAL:
  enabled: true
  weight: 10
  amount: 8
  effects:
    - REGENERATION
    - ABSORPTION
```
**Параметры:**
- `enabled` (bool)
- `weight` (int)
- `amount` (int) — сколько единиц здоровья восстановить
- `effects` (список строк) — список эффектов зелья (по стандарту Minecraft)
- `execute` (секция, опционально) - секция для цепочки команд/событий (см. раздел "Цепочка событий")

---

### DEFAULT
**Описание:** Подстраховочное действие, если не получилось подобрать событие. Обычно ничего не делает или выдаёт небольшой эффект.
**Параметры:**
- `enabled` (bool)
- `weight` (int)
- `execute` (секция, опционально) - секция для цепочки команд/событий (см. раздел "Цепочка событий")

---

## Поддерживаемые плейсхолдеры

В строках команд (`COMMAND_EXEC`, `PLAYER_COMMAND`) и других местах, где это предусмотрено логикой события, могут использоваться следующие плейсхолдеры:

-   `%player%`: Имя игрока, активировавшего лакиблок.
-   `%location%`: Координаты лакиблока (X, Y, Z).
-   Другие плейсхолдеры могут быть добавлены в реализации пользовательских событий.

---

## Цепочка событий (`EventChainUtil`)

Плагин поддерживает выполнение последовательности команд или других событий, указанных в секции `execute` внутри конфигурации события. Это позволяет создавать сложные комбинации действий.

**Важно:** Секция `execute` может быть добавлена в конфигурацию *любого* события (не только на уровне типа/уровня лакиблока), позволяя выполнять команды или другие события после завершения основного действия.

Пример использования в `luckyblocks.yml`:

```yaml
events:
  MY_CUSTOM_EVENT:
    enabled: true
    weight: 100
    # Параметры MY_CUSTOM_EVENT
    execute:
      PlayerCommandEvent:
        - "say Привет от лакиблока!"
        - "me машет рукой"
      CommandExecEvent:
        - "give %player% diamond 1"
      # Можно вкладывать другие execute секции для более сложных цепочек
      execute:
        PlayerCommandEvent:
          - "say Вторая волна команд!"
```

В этом примере после выполнения логики `MY_CUSTOM_EVENT` будут последовательно выполнены команды из секции `execute`.

---

## Собственные события/кастомизация

Можно создавать собственные события, реализовав интерфейс `ICustomEvent`. Этот интерфейс имеет один метод `execute`, который содержит логику вашего события.

```java
public interface ICustomEvent {
    void execute(Player player, Location location, ConfigurationSection eventConfig, LuckyBlockPlugin plugin);
}
```

-   `player`: Игрок, который активировал лакиблок.
-   `location`: Местоположение лакиблока.
-   `eventConfig`: Секция конфигурации из `luckyblocks.yml` для данного события, содержащая его параметры.
-   `plugin`: Экземпляр главного класса плагина.

После создания класса события, вам необходимо зарегистрировать его в `EventRegistry` плагина. Обычно это делается в методе `onEnable` главного класса плагина.

---

## Технологии и поддержка

- Bukkit/Spigot API (Java)
- YAML-конфиги
- Гибкая система ивентов для расширений

---

**Автор:**
Ayrongames и Aeris совместно для Ayronix